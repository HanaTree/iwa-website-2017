const pg=require("pg"),pg_escape=require("pg-escape");var crypto=require("crypto");const connectionString=process.env.DATABASE_URL;var config={user:process.env.PGUSER,database:process.env.PGDATABASE,password:process.env.PGPASSWORD,host:process.env.PGHOST,port:process.env.PGPORT,max:10,idleTimeoutMillis:3e4},config_1={user:"postgres",database:"iwaconference",password:"gooner95",host:"localhost",port:5432,max:10,idleTimeoutMillis:3e4};const pg_pool=new pg.Pool(config);var authenticate=function(o,e){var r=o.password,s=o.username;console.log("AUTH:"+s+" attempting to authenticate..");var n=crypto.createHash("md5").update(r).digest("hex");pg_pool.connect(function(o,r,c){if(o)return console.log(o);r.query("SELECT abstract_ids FROM users WHERE user_id=$1 AND password=$2",[s,n],function(o,r){c(),o?e("error"):0==r.rowCount?e("invalid"):(console.log("AUTH: "+s+" authenticated"),e(r.rows[0].abstract_ids))})})},add_user=function(o,e){var r=o.password,s=o.email,n=o.user_id,c=o.a_ids,t=crypto.createHash("md5").update(r).digest("hex");if(void 0===c)pg_pool.connect(function(o,r,c){if(o)return console.error(o);r.query("INSERT INTO users VALUES($1, $2, NULL, $3)",[n,t,s],function(o,r){c(),o?(console.log(o),e("error")):(console.log("AUTH: Added User"),e("success"))})});else{var i="";i+="{",i+=c.toString(),i+="}",c=i,console.log(c),pg_pool.connect(function(o,r,i){if(o)return console.error(o);r.query("INSERT INTO users VALUES($1, $2, $3, $4)",[n,t,c,s],function(o,r){i(),o?(console.log(o),e("error")):(console.log("AUTH: Added User"),e("success"))})})}},classify_country=function(o,e){console.log("AUTH: Classifying Country "+o);var r=String(o);pg_pool.connect(function(o,s,n){if(o)return console.error(o);s.query("SELECT class from countries WHERE LOWER(country_name)=LOWER($1)",[r],function(o,s){n(),o||0==s.rowCount?(console.log(o),e("error")):"hic"==s.rows[0].class?(console.log("AUTH: "+r+" is HIC"),e("hic")):"lic"==s.rows[0].class&&(console.log("AUTH: "+r+" is LIC"),e("lic"))})})},check_if_member=function(o,e,r){var s=o,n=pg_escape(e);console.log("AUTH: Checking if "+n+" is a member"),pg_pool.connect(function(o,c,t){if(o)return console.error(o);c.query("SELECT * FROM iwa_members WHERE iwa_members.membership_no=$1 AND LOWER(iwa_members.family_name)=LOWER($2)",[s,n],function(o,s){t(),o?(console.error(o),r("error")):0==s.rowCount?(console.error("AUTH: "+e+" not a member"),r("invalid")):(console.log("AUTH: "+e+" is a member"),r(s.rows[0]))})})};module.exports={authenticate:authenticate,add_user:add_user,check_if_member:check_if_member,classify_country:classify_country};